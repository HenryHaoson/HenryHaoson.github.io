---
layout: post
title: 类文件结构
date: 2017-7-28
categories: blog
tags: [JVM]
description: Class文件是虚拟节能够识别的文件类型，而这种文件结构是固定的。

---
1个字节＝2个16进制字符，一个16进制位＝0.5个字节
* 1.魔数 magic
    > u4 4个字节 作用是确定这个文件是否为一个呗虚拟机接受的Class文件。
* 2.Class文件版本 Minor Version Major Version
    > u2 u2 第5、6字节是次版本号，7、8字节是主版本号（5、6、7、8是因为Class文件结构时严格固定的）。
* 3.常量池  CP
    >cpc(constant_pool_count)常量容量计数器是从1开始的，不是从0开始，如果cpc=22，那就有21个常量，索引值就是从1～21。第0项空余出来是为了后面某些执行过常量池的索引值的数据在特定情况下可以表达“不需要引用任何常量池项目”的含义。
    >cp中主要存放两种常量，一种是字面量(Literal)还有一种是符号引用(Symbolic References)。字面量跟java层面的常量概念类似(文本字符串，声明为final的常量)，字符引用是编译原理方面的概念，包括三类常量：
    * 类和接口的全限定名(Fully Qualified Name)
    * 字段的名称和描述符(Descriptor)
    * 方法单名称和描述符
    常量池的每一项都是一个表，总共有14个表。
    14种常量类型都有自己的结构
* 4.访问标志
    > u2 用于标志一些类或者接口层次的访问信息，Class是类还是接口，是不是public，是否是abstract，是否是final。
* 5.类索引，父类索引，接口索引集合
    >Class由这3项确定类的继承关系。类索引(this_class)确定这个类的全限定名，父类索引确定这个类父类的全限定名，由于java是但继承，所以除了object类，其他所有类的父类索引都不为0.类索引和父类索引各自指向一个类型是CONSTANT_Class_info。这个常量指向一个类型是CONSTANT——utf8_info的常量，记录着全限定名。

    >接口索引集合，分为接口计数器(interfaces_count)和索引表，计数器用来记录索引表的容量，如果没有实现任何接口，那么该计数器值为零，后面的索引表不再占用字节。
* 6.字段表集合
    >用来描述类或者接口声明的变量，分为实例级变量和类级变量（是否是static修饰）。可以描述的信息很多，字段的作用域（public，private，protected），字段的类型（类级，实例级），可变性（final），并发可见性（volatile，是否强制从主存中读写），是否被序列化（transient），字段数据类型（基本类型，对象（引用类型），数组），字段名称（指向常量池）。

    >结构中有name_index和descriptor_index两个索引项，都是对常量池的引用，分别对应着简单名称（a）和字段描述符（[[Ljava/lang/String;）。
    
* 7.方法表集合
    >方法表的结构和字段表基本一样，仅仅在访问标志和属性表集合的可选项中有区别。
    >方法中的代码呗编译器编译成字节码指令后，存放在方法属性表集合中名为'code'的属性中。

* 8.属性表集合
    >Class文件，字段表，方法表都可以携带自己的属性表集合。
    
    有几个比较重要的属性
    * Code属性
    > java方法体内的代码经过javac编译器编译后会转变成为二进制字节码指令存储在code属性内，Code属性出现在方法表的属性集合中（接口和抽象类中的方法不存在code属性）。
    > 属性表结构中有max_stack属性，代表着操作数栈的最大深度，max_locals代表局部变量需要的存储空间大小（单位是slot）。code_length和code属性就是用来存储编译后的二进制字节码指令（虚拟机规范一个方法不允许超过65535条字节码指令。

    * SourceFile属性
    > 用于记录生成这个Class文件的源码文件的名称，一般来说，类名和文件名是一致的，但是也有特殊情况，比如说内部类。

    * ConstantValue
    >这个属性用来通知虚拟机自动为静态变量赋值。对非静态变量（实例变量）的赋值是在实例构造器<init>方法中进行的，而静态变量（类变量）有两种方式实现，一种是在类构造器<cinit>方法中执行，另一种是使用ConstantValue属性。

    * Signature 
    > 这个属性是jdk1.5新增的，是用来解决java伪泛型实现过程中类型擦除的问题，可以通过反射的技术最终调用Signature属性来获取这个泛型类型。