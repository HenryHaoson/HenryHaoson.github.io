---
layout: post
title: 责任链的一次使用
date: 2019-11-5
categories: blog
tags: [design 设计模式]
description: 认为这是一次很好的使用，顺利的解决了问题
---

### 1.问题导火索
之前在开发的时候遇到了关于焦点的bug。于是就去看了一下Android的焦点处理方式。

其中就有一个问题是当一个view需要获取焦点的时候，怎么把焦点给他呢。也就是如何分发焦点。（再抽象一点就是view发出一个获取焦点的请求，其他view怎么响应）

![焦点分发](https://upload-images.jianshu.io/upload_images/3351492-a6613ee0a4608889.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


其中发现一个惊人的实现，那就是焦点的分发和点击事件的分发实现非常相似：都是自顶向下或者自底向上去遍历View tree中需要响应的view结点，而且后面的view可能需要前面的view的响应结果再进行响应。

点击事件传递
> Activity －> PhoneWindow －> DecorView －> ViewGroup －> ... －> View

 如果没有被消费就向上返回
 > Activity <－ PhoneWindow <－ DecorView <－ ViewGroup <－ ... <－ View


### 2.问题
他们有着类似的解决问题的思路，说明他们应对的问题本质上是一致的。并不难发现其实无论焦点分发还是点击事件分发，都属于发送一次请求要求多方响应的过程，处理方之间有依赖关系。




### 3.方案：责任链模式

https://www.runoob.com/design-pattern/chain-of-responsibility-pattern.html


以焦点分发举例，分发顺序是由View基类去控制的，获取到焦点之后的行为是每个具体的View去控制的。

### 4.方案优缺点：

优点：

1、降低耦合度。它将请求的发送者和接收者解耦。

2、简化了对象。使得对象不需要知道链的结构。

3、增强给对象指派职责的灵活性。通过改变链内的成员或者调动它们的次序，允许动态地新增或者删除责任。

4、增加新的请求处理类很方便。

缺点：


1、系统性能将受到一定影响，而且在进行代码调试时不太方便，可能会造成循环调用。

2、可能不容易观察运行时的特征，有碍于除错。

### 5.自己方案
按需分析，如果某些处理方需要依赖于
其他处理方的处理结果，那么应该使用责任链模式。如果不需要，那么可以使用生产者消费者模式。


### 6.思想
就是要对自己的工作负责，因为下一个结点的工作者很有可能是依赖上一个工作者的工作结果。以完全负责本职工作的方式来使得所有工作者只需要关心自己的工作来提高工作效率。

### 7.好评框方案-》责任链

这周做到的一个需求就很符合一个请求需要多方响应的特征。

有A、B、C 三个场景会触发回到首页弹好评弹框，他们可能会同时满足条件，会导致冲突，所以产品定义了他们的优先级，A>B>c。

如果直接按照产品的描述逻辑写代码，很有可能写成这样

```java
if(A.hasShown) {
    if(B.needShow) {

    }else if(C.hasShown){

    }else if(C.needShow){

    }

}else if(A.needShow) {
    A.show
    if(c.hasShow) {

    }else if(C.needShow){

    }

}else if(!A.needShow) {

}
...

```

但是如果把逻辑抽象一下，以优先级高低将所有场景链成一条链

```java
public void check(boolean hasShown) {
		if (isNeedShow()) {
			if (hasShown) {
				handleConflict();
			} else {
				setHasShown();
				showDialog();
			}

			if (mNextScene != null) {
				mNextScene.check(true);
			}

		} else {
			if (mNextScene != null) {
				mNextScene.check(hasShown);
			}
		}
	}

```

这样就完成了链式调用，每个场景处理的逻辑都由各个场景内部处理，场景内部也不需要知道外部冲突情况。




