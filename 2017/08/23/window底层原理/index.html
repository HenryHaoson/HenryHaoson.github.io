<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>WMS Window工作原理 | HenryHaoson</title><meta name="description" content="最近在研究framework层的代码，之前听说过一些，神马AMS，PMS，WMS 啥啥啥的。所以就来看一看WMS（Window Manager Service）。"><meta name="keywords" content="Android"><meta name="author" content="HenryHaoson"><meta name="copyright" content="HenryHaoson"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="preconnect" href="//cdn.jsdelivr.net"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="WMS Window工作原理"><meta name="twitter:description" content="最近在研究framework层的代码，之前听说过一些，神马AMS，PMS，WMS 啥啥啥的。所以就来看一看WMS（Window Manager Service）。"><meta name="twitter:image" content="https://raw.githubusercontent.com/HenryHaoson/HenryHaoson.github.io/source/source/images/default_bg.jpeg"><meta property="og:type" content="article"><meta property="og:title" content="WMS Window工作原理"><meta property="og:url" content="https://henryhaoson.github.io/2017/08/23/window%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/"><meta property="og:site_name" content="HenryHaoson"><meta property="og:description" content="最近在研究framework层的代码，之前听说过一些，神马AMS，PMS，WMS 啥啥啥的。所以就来看一看WMS（Window Manager Service）。"><meta property="og:image" content="https://raw.githubusercontent.com/HenryHaoson/HenryHaoson.github.io/source/source/images/default_bg.jpeg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'false'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://henryhaoson.github.io/2017/08/23/window%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/"><link rel="prev" title="呼啦啦" href="https://henryhaoson.github.io/2017/09/04/%E5%91%BC%E5%95%A6%E5%95%A6/"><link rel="next" title="ScrollView嵌套RecyclerView导致的Recycler的问题。" href="https://henryhaoson.github.io/2017/08/16/RecyclerView%20%E5%B5%8C%E5%A5%97%E5%9C%A8NestedScrollerView%E4%B8%AD%E9%AB%98%E5%BA%A6%E9%97%AE%E9%A2%98/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight_copy: 'false',
  highlight_lang: 'true',
  highlight_shrink: 'false',
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  copyright: undefined,
  copy_copyright_js: false,
  ClickShowText: undefined,
  medium_zoom: 'false',
  Snackbar: undefined
  
}</script><meta name="generator" content="Hexo 4.2.0"></head><body><div id="header"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/home/">HenryHaoson</a></span><i class="fa fa-bars fa-fw toggle-menu pull_right close" aria-hidden="true"></i><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/home/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></span><span class="pull_right" id="search_button"></span></div></div><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="lazyload avatar_img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'"></div><div class="mobile_post_data"><div class="mobile_data_item is_center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">34</div></a></div></div><div class="mobile_data_item is_center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">12</div></a></div></div><div class="mobile_data_item is_center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">3</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/home/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">目录</div><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Window-对象的创建"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">Window 对象的创建</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#activity-中-window-的创建"><span class="toc_mobile_items-number">1.1.</span> <span class="toc_mobile_items-text">activity 中 window 的创建</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#window-的工作原理"><span class="toc_mobile_items-number">2.</span> <span class="toc_mobile_items-text">window 的工作原理</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#WindowManager"><span class="toc_mobile_items-number">2.1.</span> <span class="toc_mobile_items-text">WindowManager</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#Window-添加过程"><span class="toc_mobile_items-number">2.2.</span> <span class="toc_mobile_items-text">Window 添加过程</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#activity-中-window-的工作"><span class="toc_mobile_items-number">2.3.</span> <span class="toc_mobile_items-text">activity 中 window 的工作</span></a></li></ol></li></ol></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Window-对象的创建"><span class="toc-number">1.</span> <span class="toc-text">Window 对象的创建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#activity-中-window-的创建"><span class="toc-number">1.1.</span> <span class="toc-text">activity 中 window 的创建</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#window-的工作原理"><span class="toc-number">2.</span> <span class="toc-text">window 的工作原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#WindowManager"><span class="toc-number">2.1.</span> <span class="toc-text">WindowManager</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Window-添加过程"><span class="toc-number">2.2.</span> <span class="toc-text">Window 添加过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#activity-中-window-的工作"><span class="toc-number">2.3.</span> <span class="toc-text">activity 中 window 的工作</span></a></li></ol></li></ol></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://raw.githubusercontent.com/HenryHaoson/HenryHaoson.github.io/source/source/images/default_bg.jpeg)"><div id="post-info"><div id="post-title"><div class="posttitle">WMS Window工作原理</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2017-08-23<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-04-14</time><span class="post-meta__separator mobile_hidden">|</span><span class="mobile_hidden"><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/blog/">blog</a></span><div class="post-meta-wordcount"><i class="fa fa-eye post-meta__icon" aria-hidden="true">       </i><span>阅读量: </span><span id="busuanzi_value_page_pv"></span></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><p>最近在研究 framework 层的代码，之前听说过一些，神马 AMS，PMS，WMS 啥啥啥的。所以就来看一看 WMS（Window Manager Service）。</p>
<h2 id="Window-对象的创建"><a href="#Window-对象的创建" class="headerlink" title="Window 对象的创建"></a>Window 对象的创建</h2><p>在 android 机制里面，view 是视图呈现的载体，然而 view 也不能够单独存在，它也必须依赖 window 才能存在。</p>
<p>打开源码可以发现 window 是一个抽象类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Window</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DECOR_CAPTION_SHADE_AUTO = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DECOR_CAPTION_SHADE_DARK = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DECOR_CAPTION_SHADE_LIGHT = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@deprecated</span> */</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_FEATURES = <span class="number">65</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FEATURE_ACTION_BAR = <span class="number">8</span>;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>Window 的具体实现类是 PhoneWindow.那 PhoneWindow 又是通过什么、什么时候创建的呢，毕竟我们没有在开发中直接创建过 PhoneWindow。根据上面的结论，activity 也是依赖一个 window 的，我们以 activity 为例，来看一看到底这个 Window 是什么时候创建的。（以下会涉及到一些 AMS 的知识，可能会比较难以下咽(;´༎ຶД༎ຶ`)）。</p>
<h3 id="activity-中-window-的创建"><a href="#activity-中-window-的创建" class="headerlink" title="activity 中 window 的创建"></a>activity 中 window 的创建</h3><p>这里会涉及一点 Activity 的启动流程。。。因为我们要知道 acitvity 的创建过程。</p>
<p>我们知道应用程序的入口是 ActivityThread，activity 的创建也是也是交给 ActivityThread 实现的。这里不啰嗦，反正就是 ActivityThread 和 AMS（ActicityManagerService）的频繁 IPC 交互。最终会在 ActivityThread 的 performLaunchActivity()方法中进行 activity 的加载。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">java.lang.ClassLoader cl = r.packageInfo.getClassLoader();</span><br><span class="line"><span class="comment">//Instrumentation的作用是监听应用程序和系统化交互的</span></span><br><span class="line">activity = mInstrumentation.newActivity(cl, component.getClassName(), r.intent);</span><br><span class="line"><span class="keyword">if</span> (acticity != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="comment">//context的创建，其实activity本质上也是一个context</span></span><br><span class="line"> Context appContext = createBaseContextForActivity(r, activity);</span><br><span class="line"> <span class="comment">//...</span></span><br><span class="line"> activity.attach(appContext, <span class="keyword">this</span>, getInstrumentation(), r.token, r.ident,</span><br><span class="line"> app, r.intent, 此处省略一堆参数)；</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关键就在这个 attach 方法，这个方法会传入一堆参数，将 activity 关联其运行时所依赖的上下文环境变量。Window 对象就是在这个方法里面创建的，并且 activity 实现了 window 的 Callback 接口，所以党 window 的状态发生改变会回调 activity 的相应方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//window对象的创建</span></span><br><span class="line">mWindow = PolicyManager.makeNewWindow(<span class="keyword">this</span>);</span><br><span class="line"><span class="comment">//window的一些配置</span></span><br><span class="line">mWindow.setCallback(<span class="keyword">this</span>);</span><br><span class="line">mWindow.setOnWindowDismissedCallback(<span class="keyword">this</span>);</span><br><span class="line"><span class="comment">//....</span></span><br></pre></td></tr></table></figure>

<p>可以看到 Window 的创建是通过 PolicyManager 来实现的。那我们就来看看 PolicyManager 是一个神马东西。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PolicyManager</span></span>&#123;</span><br><span class="line">    <span class="comment">//Policy实现类</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String POLICY_IMPL_CLASS_NAME = <span class="string">"com.android.internal.policy.impl,Policy"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> IPolicy sPolicy;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            Class policyClass = Class.forName(POLICY_IMPL_CALSS_NAME);</span><br><span class="line">            sPolicy = (IPolicy)policyClass.<span class="keyword">new</span> Instance();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>&#123;</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">PolicyManager</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//这里就是创建window的地方</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Window <span class="title">makeNewWindow</span><span class="params">(Context context)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sPolicy.makeNewWindow(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LayoutInflater <span class="title">makeNewLayoutInflater</span><span class="params">(Context context)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sPolicy.makeNewLayoutInflater(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面的代码可以看出 Policy 也只是一个代理类，但是他的一个巧妙的地方就是通过反射来构造 Policy 对象，实现了对外隐藏实现。没办法，还要再来看一看 Policy 的代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Pulic <span class="class"><span class="keyword">class</span> <span class="title">Policy</span> <span class="keyword">implements</span> <span class="title">IPolicy</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="comment">//哇！终于等到你。。。</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Window <span class="title">makeNewWindow</span><span class="params">(Context context)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PhoneWindow(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//这里还有一个重要的对象的创建,LayoutInflater对象的实例化所在</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LayoutInflater <span class="title">makeNewLayoutInflater</span><span class="params">(Context context)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PhoneLayoutInflater(context);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>终于等到你，终于等到你，终于等到你。到这里 window 对象就就已经创建好了（到这里也只是创建好了 window 对象。接下来我们还要看看 window 是怎么工作的）。</p>
<h2 id="window-的工作原理"><a href="#window-的工作原理" class="headerlink" title="window 的工作原理"></a>window 的工作原理</h2><p>在这里先说明一下，window 是一个比较抽象的东西，每一个 window 都对应着一个 View 和一个 ViewRootImpl(这个也可以说是 view 工作的入口)，ViewRootImpl 将 Window 和 View 联系起来。</p>
<h3 id="WindowManager"><a href="#WindowManager" class="headerlink" title="WindowManager"></a>WindowManager</h3><p>书上说 WindowManager 是 Window 外界访问入口。我觉得这样说是不合适的，其实我们可以很方便的获得 view 的 window 对象，我觉得 WindowManager 主要是用来和 WindowManagerService 交互的。</p>
<p>WindowManager 提供了三个操作 Window 的方法，<code>addView</code>,<code>updateViewLayout</code>,<code>removeView</code>。从方法名就可以看出来对 Window 操作其实就是对 View 的操作。</p>
<p>WindowManager 是一个接口，他的实现类是 WindowManagerImpl，这个类又是在哪实现的呢？</p>
<p>其实 WindowManager 也是 ContextImpl 中注册点服务之一。代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">registerService(WINDOW_SERVICE, <span class="keyword">new</span> ServiceFetcher()&#123;</span><br><span class="line">    Display mDefaultDisplay;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getService</span><span class="params">(ContextImpl ctx)</span></span>&#123;</span><br><span class="line">        Display display = ctx.mDisplay;</span><br><span class="line">        <span class="keyword">if</span>(display == <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(mDefaultDisplay == <span class="keyword">null</span>)&#123;</span><br><span class="line">                DisplayManager dm = (DisplayManager)ctx.getOuterContext().getSystemService(Context.DISPLAY_SERVICE);</span><br><span class="line">                mDefaultDisplay = dm.getDisplay(Dispaly.DEFAULT_DISPLAY);</span><br><span class="line">            &#125;</span><br><span class="line">            display = mDefaultDisplayl;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> WindowManagerImpl(disolay);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>下面又是一些 WindowManager 操作的源码分析了，这里就不重新造轮子了，直接按照《人体艺术探索》上的思路和源码来分析( ^ _ ^ )v</p>
<p>这里就说一个 addView 吧，其他的可以去找资料，网上很多都是直接抄的《人体艺术探索》的。</p>
<h3 id="Window-添加过程"><a href="#Window-添加过程" class="headerlink" title="Window 添加过程"></a>Window 添加过程</h3><p>window 的添加就是通过 WindowManager 的<code>addView</code>方法,这里又是一样的套路，WindowManager 只是一个接口，他需要一个实现类，那就是 WindowManager+Impl(~ _ ~;)，下面看看 WindowManagerImpl 的这三个方法的实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(View view, ViewGroup.Layoutparams params)</span> </span>&#123;</span><br><span class="line">    mGlobal.addView(view, params, mDisplay, mParentWindow);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateViewLayout</span><span class="params">(View view, ViewGroup.Layoutparams params)</span> </span>&#123;</span><br><span class="line">    mGlobal.updateViewLayout(view, params);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeView</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">    mGlobal.removeView(view);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到 WindowManagerImpl 也没有真正实现 window 的操作，而是交给 WindowManagerGlobal 来处理，由此就可以看出 WindowManagerImpl 就是一个代理类(书上说这是桥接模式，我一直没有研究过侨界模式，但就是看着像代理模式）。所以说真正的大头还是 WindowManagerGlobal。</p>
<p>WindowManagerGlobal 以工厂形式对外提供自己的实例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> WindowManagerGlobal mGlobal = WindowManagerGlobal.getInstance();</span><br></pre></td></tr></table></figure>

<p>WindowManagerGlobal 中 addView 方法分为下面几个步骤</p>
<ul>
<li><p>检查参数是否合法，如果是子 Window 那么还需要调整一些布局参数</p>
</li>
<li><p>创建 ViewRootImpl 并将 View 添加到列表中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;View&gt; mViews = <span class="keyword">new</span> ArrayList&lt;View&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;ViewRootImpl&gt; mRoots = <span class="keyword">new</span> ArrayList&lt;ViewRootImpl&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;WindowManager.Layoutparams&gt; mParams = <span class="keyword">new</span> ArrayList&lt;WindowManager.Layoutparams&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArraySet&lt;View&gt; mDyingViews = <span class="keyword">new</span> ArraySet&lt;View&gt;();</span><br></pre></td></tr></table></figure>
<pre><code>上面mViews存储的是所有Window对应的View；我们上面说过，每一个Window都对应一个View ，并且每个Window都有一个ViewRootImpl对象，就是这边的mRoots,ViewRootImpl继承了Handler类，是native与java层的View系统通信的桥梁。

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ViewRootImpl</span><span class="params">(Context context, Display display)</span></span>&#123;</span><br><span class="line">    mContext = context;</span><br><span class="line"><span class="comment">//获取windowSession，与WMS建立连接</span></span><br><span class="line">mWindowSession = WindowManagerGlobal.getWindowSeesion();</span><br><span class="line"><span class="comment">//保存当前线程，更新UI只能在创建ViewRootImpl的线程中执行</span></span><br><span class="line"><span class="comment">//创建ViewRootImpl的线程就是UI线程，也就是主线程。</span></span><br><span class="line">mThread = Thread.currentThread();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></code></pre><p>而且也说过 ViewRootImpl 会将 Window 和 View 关联，是怎样关联的呢，关联的一方 面我们可以看看下面代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;这也算是关联的一方面</span><br><span class="line">root &#x3D; new ViewRootImpl(view.getContext(), display);</span><br><span class="line">view.setLayoutParams(wParams);</span><br><span class="line"></span><br><span class="line">    mView.add(view);</span><br><span class="line">    mRoots.add(root);</span><br><span class="line">    mParams.add(wParams);</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过 ViewRootImpl 来更新界面并完成 Window 的添加</p>
<p>这个步骤由 ViewRootImpl 的 setView 方法完成(这个方法完成了关联)。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root.setView(view, wparams, panelParentView());</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setView</span><span class="params">(View view, WindowManager.LayoutParams attrs, View panelParentView)</span></span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>)&#123;</span><br><span class="line">       requestLayout();</span><br><span class="line">       <span class="keyword">try</span>&#123;</span><br><span class="line">         res = sWindowSession.add(mWindow, mWindowAttributes,getHostVisibility(), mAttachInfo.mContentInsets);</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>都知道 View 的绘制过程是由 ViewRootImpl 发起的。setView 内部会通过 requestLayout 来完成异步刷新。下面的代码中，scheduleTraversals 实际上是 View 绘制的入口。ScheduleTraversals 最终会调用 ViewRootImpl 的 performTraverslas 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestLayout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mHandingLayoutInLayoutRequest) &#123;</span><br><span class="line">        checkThread ();</span><br><span class="line">        mLayoutRequested = <span class="keyword">true</span>;</span><br><span class="line">        ScheduleTraversals();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ScheduleTraversals</span><span class="params">()</span></span>&#123;</span><br><span class="line">   <span class="keyword">if</span>(!mTraversalScheduled)&#123;</span><br><span class="line">      mTraversalScheduled = <span class="keyword">true</span>;</span><br><span class="line">      sendEmptyMessage(DO_TRAVERSAL);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>sendEmptyMessage(DO_TRAVERSAL);</code>这个函数向 Handler 发送一个消息,出发整个视图树的绘制，也就是最终执行 performTraversals 函数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performTraversals</span><span class="params">()</span></span>&#123;</span><br><span class="line"> <span class="comment">//获取Surface对象，用于图形绘制</span></span><br><span class="line"> <span class="comment">//三大过程</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里就不分析 performTraversals 方法了，因为这就属于 View 绘制范畴了，不在本文的讨论范围之内。可以看我之前写的这篇文章<a href="https://henryhaoson.github.io/2017/06/15/2017-6-5-View%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/">view 工作原理</a>。</p>
<p>接着会通过 WindowSession 最终完成 Window 的添加过程。在下面代码中，mWindowSession 的类型是 IWindowSession，这是一个 Binder 对象，实现类是 Session。这就说明这是一个 IPC 过程，也就是离 WMS 不远了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    mOrigWindowType = mWindowAttributes.type;</span><br><span class="line">    mAttachInfo.mRecomputeClobalAttributes =<span class="keyword">true</span>;</span><br><span class="line">    collectViewAttributes();</span><br><span class="line">    res = mWindowSession.addToDisplay(mWindow, mSeq, mWindowAttributes,</span><br><span class="line">          getHostVisibility(), mDisplay.getDisplayId(),</span><br><span class="line">          mAttachinfo.mContentInsets, mInputChannel);</span><br><span class="line">&#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">    mAdded = <span class="keyword">false</span>;</span><br><span class="line">    mView = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//...对异常的处理</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 Session 内部，会将添加操作最终交给 WMS（WindowManagerService）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">addToDisplay</span><span class="params">(IWindow window,...省略若干参数)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mService.addWindow(<span class="keyword">this</span>, window, seq, attrs,</span><br><span class="line">    viewVisibility, displayId, outContentInsets, outInputChannel);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>终于看到了神秘的 WMS(就是上面的 mService)。在这先不分析 WMS 的内部操作了(还没看(; ^ _ ^A )。</p>
</li>
</ul>
<p>这里看完了 Window 添加到 WMS 中的过程，再回到 Activity</p>
<h3 id="activity-中-window-的工作"><a href="#activity-中-window-的工作" class="headerlink" title="activity 中 window 的工作"></a>activity 中 window 的工作</h3><p>上面已经分析了 acticity 的 window 对象创建的过程，那么 window 是证明工作的呢，又是在何时绑定的呢（其实就是找 WindowManager 何时执行 addView 方法）。</p>
<p>我们从 activity 的生命周期角度来分析。</p>
<p>我们知道在 activity 的 onCreate 方法里会执行 setContentView 方法，这个方法最终也是由 window 来执行的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(@LayoutRes <span class="keyword">int</span> layoutResID)</span> </span>&#123;</span><br><span class="line">    getDelegate().setContentView(layoutResID);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这你可能会发现，不对啊，说好的 window 呢，getDelegate()是个什么鬼。其实我这个看的是 AppCompatActivity 的源码，如果是 acticity 的远源码，那就是 getWIndow(),呢我们就来看一看这个 getDelegate()说到底是啥。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> AppCompatDelegate <span class="title">getDelegate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mDelegate == <span class="keyword">null</span>) &#123;</span><br><span class="line">        mDelegate = AppCompatDelegate.create(<span class="keyword">this</span>, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mDelegate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现这是获取一个类型为 AppCompatDelegate 的 mDelegate 对象。我们再来看一看他的 create 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create a &#123;<span class="doctag">@link</span> android.support.v7.app.AppCompatDelegate&#125; to use with &#123;<span class="doctag">@code</span> activity&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> callback An optional callback for AppCompat specific events</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AppCompatDelegate <span class="title">create</span><span class="params">(Activity activity, AppCompatCallback callback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> create(activity, activity.getWindow(), callback);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create a &#123;<span class="doctag">@link</span> android.support.v7.app.AppCompatDelegate&#125; to use with &#123;<span class="doctag">@code</span> dialog&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> callback An optional callback for AppCompat specific events</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AppCompatDelegate <span class="title">create</span><span class="params">(Dialog dialog, AppCompatCallback callback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> create(dialog.getContext(), dialog.getWindow(), callback);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> AppCompatDelegate <span class="title">create</span><span class="params">(Context context, Window window,</span></span></span><br><span class="line"><span class="function"><span class="params">        AppCompatCallback callback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> sdk = Build.VERSION.SDK_INT;</span><br><span class="line">    <span class="keyword">if</span> (BuildCompat.isAtLeastN()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AppCompatDelegateImplN(context, window, callback);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sdk &gt;= <span class="number">23</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AppCompatDelegateImplV23(context, window, callback);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sdk &gt;= <span class="number">14</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AppCompatDelegateImplV14(context, window, callback);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sdk &gt;= <span class="number">11</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AppCompatDelegateImplV11(context, window, callback);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AppCompatDelegateImplV9(context, window, callback);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到它这边其实是传了 window 对象的。其实最终的 setContent 方法还是交给 Window 的。</p>
<p>我们来看 Window(实际上是 PhoneWindow)的 setContentView 方法。</p>
<p>window 的 setContentView 其实可以分为 3 个步骤</p>
<ul>
<li><p>1.木有 DecorView 就创建。</p>
<p>DecorView 是 Activity 的顶级 View，关于 DecorView 的知识可以自己去查。DecorView 的创建实在 installDecor 方法中实现的，在 DecorView 中会调用 generateDecor 方法。</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> DecorView <span class="title">generateDecor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DecorView(getContext, -<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>2.这样实例化之后还只是一个空白的 View，之后会通过 LayoutInflater 来将布局文件中的布局添加到 DecorView 的 mContentParent 中。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mLayoutInflater.inflate(layoutResID, mContentParent);</span><br></pre></td></tr></table></figure></li>
<li>3.回调 activity 的 onContentChanged 方法通知 activity 视图已经发生改变。<br>这个方法其实是空实现，可以自己定义处理策略。</li>
</ul>
<p>经过上面的过程，setContentView 实现的 DecorView 的创建。但是还没有分析到 window 是如何添加到 WMS 中的,只有执行 WindowManager 的 addView 方法，window 才能真正的工作。</p>
<p>在 ActivityThread 的 handleResumeActivity 方法中，会调用 activity 的 onResume 方法，接着会调用 activity 的 makeVisible 方法。在这个方法里会实现 addView 操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">makeVisible</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mWindowAdded)&#123;</span><br><span class="line">        <span class="comment">//获取WM对象</span></span><br><span class="line">        ViewManager wm =getWindowManager();</span><br><span class="line">        <span class="comment">//执行addView方法。添加window的入口</span></span><br><span class="line">        wm.addView(mDecor, getWindow().getAttributes());</span><br><span class="line">        mWindowAdded = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mDecorr.setVisibility(View,VISIBLE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样 activiy 的 window 就成功添加了。</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">HenryHaoson</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://henryhaoson.github.io/2017/08/23/window%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/">https://henryhaoson.github.io/2017/08/23/window%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://henryhaoson.github.io">HenryHaoson</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android/">Android    </a></div><div class="post_share"><div class="social-share" data-image="https://raw.githubusercontent.com/HenryHaoson/HenryHaoson.github.io/source/source/images/default_bg.jpeg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button"><i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.jpg"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.jpg"><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2017/09/04/%E5%91%BC%E5%95%A6%E5%95%A6/"><img class="prev_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>呼啦啦</span></div></a></div><div class="next-post pull_right"><a href="/2017/08/16/RecyclerView%20%E5%B5%8C%E5%A5%97%E5%9C%A8NestedScrollerView%E4%B8%AD%E9%AB%98%E5%BA%A6%E9%97%AE%E9%A2%98/"><img class="next_cover lazyload" data-src="https://raw.githubusercontent.com/HenryHaoson/HenryHaoson.github.io/source/source/images/default_bg.jpeg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>ScrollView嵌套RecyclerView导致的Recycler的问题。</span></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2018/02/05/FileProvider/" title="FileProvider 学习"><img class="relatedPosts_cover lazyload"data-src="https://raw.githubusercontent.com/HenryHaoson/HenryHaoson.github.io/source/source/images/default_bg.jpeg"><div class="relatedPosts_title">FileProvider 学习</div></a></div><div class="relatedPosts_item"><a href="/2016/10/10/2016-02-22-搭建自己的fragment库，管理fragment栈/" title="搭建自己的fragment库，管理自己的fragment栈"><img class="relatedPosts_cover lazyload"data-src="https://raw.githubusercontent.com/HenryHaoson/HenryHaoson.github.io/source/source/images/default_bg.jpeg"><div class="relatedPosts_title">搭建自己的fragment库，管理自己的fragment栈</div></a></div><div class="relatedPosts_item"><a href="/2017/05/20/2017-5-20-Android Themes & styles, a real architecture/" title="theme"><img class="relatedPosts_cover lazyload"data-src="https://raw.githubusercontent.com/HenryHaoson/HenryHaoson.github.io/source/source/images/default_bg.jpeg"><div class="relatedPosts_title">theme</div></a></div><div class="relatedPosts_item"><a href="/2017/06/15/2017-6-5-View工作原理/" title="view工作原理"><img class="relatedPosts_cover lazyload"data-src="https://raw.githubusercontent.com/HenryHaoson/HenryHaoson.github.io/source/source/images/default_bg.jpeg"><div class="relatedPosts_title">view工作原理</div></a></div><div class="relatedPosts_item"><a href="/2017/05/07/2017-5-4-封装Retrofit/" title="封装Retrofit"><img class="relatedPosts_cover lazyload"data-src="https://raw.githubusercontent.com/HenryHaoson/HenryHaoson.github.io/source/source/images/default_bg.jpeg"><div class="relatedPosts_title">封装Retrofit</div></a></div><div class="relatedPosts_item"><a href="/2017/07/03/2017-7-3hashCode/" title="hashCode"><img class="relatedPosts_cover lazyload"data-src="https://raw.githubusercontent.com/HenryHaoson/HenryHaoson.github.io/source/source/images/default_bg.jpeg"><div class="relatedPosts_title">hashCode</div></a></div></div><div class="clear_both"></div></div></div></div><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2018 - 2020 By HenryHaoson</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="/js/tw_cn.js"></script><script>translateInitilization()
</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script></body></html>